name: SageMaker ML Pipeline CI/CD

permissions:
  id-token: write
  contents: read

on:
  push:
    branches: [ main ]
    paths:
      - "Sagemaker/**"
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  AWS_ROLE_ARN: arn:aws:iam::227295996532:role/jaime-sagemaker-pipeline
  ECR_REGISTRY: 227295996532.dkr.ecr.ap-northeast-1.amazonaws.com
  ECR_REPO_PREFIX: jaime-dev

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Debug AWS identity (before pipeline)
        run: |
          aws sts get-caller-identity


      # --------------------------------------------------
      # Detect & print changed folders + files
      # --------------------------------------------------
      - name: Detect changed components and files
        run: |
          echo "Changed files detected:"
          echo "-----------------------"

          git diff --name-only \
            ${{ github.event.before }} \
            ${{ github.sha }} \
            | grep "^Sagemaker/" \
            | while read file; do
                folder=$(echo "$file" | awk -F/ '{print $2}')
                subfile=$(echo "$file" | cut -d/ -f3-)
                echo "- Folder: $folder"
                echo "  - $subfile"
              done

          CHANGED_COMPONENTS=$(git diff --name-only \
            ${{ github.event.before }} \
            ${{ github.sha }} \
            | grep "^Sagemaker/" \
            | awk -F/ '{print $2}' \
            | sort -u)

          echo ""
          echo "Changed components:"
          for comp in $CHANGED_COMPONENTS; do
            echo "  - $comp"
          done

          echo "CHANGED_COMPONENTS=$CHANGED_COMPONENTS" >> $GITHUB_ENV

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
          | docker login --username AWS --password-stdin $ECR_REGISTRY

      # --------------------------------------------------
      # Build & push images with prefixed ECR repo name
      # --------------------------------------------------
      - name: Build & push changed images
        run: |
          TAG=${GITHUB_SHA::7}

          for comp in $CHANGED_COMPONENTS; do
            REPO_NAME="${ECR_REPO_PREFIX}-${comp}"
            IMAGE_URI="${ECR_REGISTRY}/${REPO_NAME}:${TAG}"

            echo "Building image for ${comp}"
            echo "ECR Repo: ${REPO_NAME}"
            echo "Image URI: ${IMAGE_URI}"

            docker build -t $IMAGE_URI Sagemaker/$comp
            docker push $IMAGE_URI

            # Export for pipeline.py
            echo "${comp}_IMAGE=${IMAGE_URI}" >> $GITHUB_ENV
          done

      # --------------------------------------------------
      # Update SageMaker Pipeline
      # --------------------------------------------------
      - name: Update SageMaker Pipeline
        working-directory: ${{ github.workspace }}
        run: |
          python3 -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install "boto3>=1.28.0" "sagemaker>=2.200.0"
          python pipeline.py
